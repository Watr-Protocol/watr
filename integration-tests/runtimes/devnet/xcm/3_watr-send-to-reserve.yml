---
# Test run with https://www.npmjs.com/package/@parity/parachains-integration-tests
settings:
  chains:
    relay_chain:
      wsPort: 9800
    statemint_parachain: &stmt_parachain
      wsPort: 9810
      paraId: &stmt_id 1000
    watr_parachain: &watr_parachain
      wsPort: 9820
  variables:
    common:
      require_weight_at_most:
        &weight_at_most { refTime: 10000000000, proofSize: 2000000 }
      weight_threshold:
        &weight_threshold { refTime: [10, 10], proofSize: [10, 10] }
    chains:
      statemint_parachain:
        asset_receiver:
          account: &stmt_asset_receiver_acc "0x8eaf04151687736326c9fea17e25fc5287613693c912909cb226aa4794f26a48" # Bob
          wallet: &stmt_asset_receiver_wallet FoQJpPyadYccjavVdTWxpxU7rUEaYhfLCPwXgkfD6Zat9QP # Bob Statemine
        asset:
          id: &stmt_asset_id 1984
          pallet_id: &stmt_assets_pallet_id 50
          local_locations:
            &stmt_local_asset_location {
              parents: 0,
              interior:
                {
                  X2:
                    [
                      { PalletInstance: *stmt_assets_pallet_id },
                      { GeneralIndex: *stmt_asset_id },
                    ],
                },
            }
          wrong_local_locations:
            &wrong_local_asset_location {
              parents: 0,
              interior:
                {
                  X2:
                    [
                      { PalletInstance: *stmt_assets_pallet_id },
                      { GeneralIndex: 1985 },
                    ],
                },
            }
          remote_locations:
            &stmt_remote_asset_location {
              parents: 1,
              interior:
                {
                  X3:
                    [
                      { Parachain: *stmt_id },
                      { PalletInstance: *stmt_assets_pallet_id },
                      { GeneralIndex: *stmt_asset_id },
                    ],
                },
            }
          wrong_remote_locations:
            &wrong_remote_asset_location {
              parents: 1,
              interior:
                {
                  X3:
                    [
                      { Parachain: 3000 },
                      { PalletInstance: *stmt_assets_pallet_id },
                      { GeneralIndex: *stmt_asset_id },
                    ],
                },
            }
        fees: &stmt_expected_fees 1000..10000
      watr_parachain:
        sovereign_account: &watr_sovereign_sibl FBeL7DUySdc1yfT9KfucQTJm4UByTW8T5X2mSQjVA8tstTf # Statemine
        destinations:
          stmt:
            &watr->stmt_dest {
              parents: 1,
              interior: { X1: { Parachain: *stmt_id } },
            }
          wrong:
            &watr->wrong_dest {
              parents: 1,
              interior: { X1: { Parachain: 3000 } },
            }
        asset_sender:
          signer: &watr_asset_sender_signer //Bob
          wallet: &watr_asset_sender_wallet 2xBchgbq7aQyGjTotgQvP9Uh76uEWfQWYBpAzJgn5dfsfhsW # Bob
        asset:
          id: &watr_asset_id 1984
          amount_to_send: &watr_asset_amount_to_send 250000000000000 # half of amount sent by reserve
        tx_cost: &watr_buy_execution_amount 100000000000000

tests:
  - name: SEND TO RESERVE
    describes:
      - name: polkadotXcm.execute (Asset) | Watr Parachain -> Statemine Parachain
        its:
          - name: Watr Parachain account should be able to reserve transfer back Asset to Statemine
            actions:
              - extrinsics:
                  - chain: *watr_parachain
                    signer: *watr_asset_sender_signer
                    pallet: polkadotXcm
                    call: execute
                    args: [
                        # message: XcmVersionedXcm
                        {
                          v3:
                            [
                              {
                                WithdrawAsset:
                                  [
                                    {
                                      id:
                                        {
                                          Concrete: *stmt_remote_asset_location,
                                        },
                                      fun:
                                        {
                                          Fungible: *watr_asset_amount_to_send,
                                        },
                                    },
                                  ],
                              },
                              {
                                InitiateReserveWithdraw:
                                  {
                                    assets: { Wild: All },
                                    reserve: *watr->stmt_dest,
                                    xcm:
                                      [
                                        {
                                          BuyExecution:
                                            {
                                              fees:
                                                {
                                                  id:
                                                    {
                                                      Concrete: *stmt_local_asset_location,
                                                    },
                                                  fun:
                                                    {
                                                      Fungible: *watr_buy_execution_amount,
                                                    },
                                                },
                                              weightLimit: Unlimited,
                                            },
                                        },
                                        {
                                          DepositAsset:
                                            {
                                              assets: { Wild: All },
                                              beneficiary:
                                                {
                                                  parents: 0,
                                                  interior:
                                                    {
                                                      X1:
                                                        {
                                                          AccountId32:
                                                            {
                                                              network,
                                                              id: *stmt_asset_receiver_acc,
                                                            },
                                                        },
                                                    },
                                                },
                                            },
                                        },
                                      ],
                                  },
                              },
                            ],
                        },
                        # maxWeight: Weight
                        *weight_at_most,
                      ]
                    events:
                      - name: assets.Burned
                        result:
                          {
                            assetId: *watr_asset_id,
                            owner: *watr_asset_sender_wallet,
                            balance: *watr_asset_amount_to_send,
                          }
                      - name: xcmpQueue.XcmpMessageSent
                      - name: polkadotXcm.Attempted
                        attributes:
                          - type: XcmV3TraitsOutcome
                            xcmOutcome: Complete
                            value:
                              { refTime: "2,000,000,000", proofSize: "131,072" }
                      - name: assets.Burned
                        chain: *stmt_parachain
                        result:
                          {
                            assetId: *stmt_asset_id,
                            owner: *watr_sovereign_sibl,
                            balance: *watr_asset_amount_to_send,
                          }
                      - name: assets.Issued
                        chain: *stmt_parachain
                        attributes:
                          - key: assetId
                            value: *stmt_asset_id
                          - key: owner
                            value: *stmt_asset_receiver_wallet

                      - name: assets.Issued
                        chain: *stmt_parachain
                        attributes:
                          - key: assetId
                            value: *stmt_asset_id

          - name: Execution filter should fail if WithdrawAsset the wrong Asset
            actions:
              - extrinsics:
                  - chain: *watr_parachain
                    signer: *watr_asset_sender_signer
                    pallet: polkadotXcm
                    call: execute
                    args: [
                        # message: XcmVersionedXcm
                        {
                          v3:
                            [
                              {
                                WithdrawAsset:
                                  [
                                    {
                                      id:
                                        {
                                          Concrete: *wrong_remote_asset_location,
                                        },
                                      fun:
                                        {
                                          Fungible: *watr_asset_amount_to_send,
                                        },
                                    },
                                  ],
                              },
                              {
                                InitiateReserveWithdraw:
                                  {
                                    assets: { Wild: All },
                                    reserve: *watr->stmt_dest,
                                    xcm: [
                                        {
                                          BuyExecution:
                                            {
                                              fees:
                                                {
                                                  id:
                                                    {
                                                      Concrete: *stmt_local_asset_location,
                                                    },
                                                  fun:
                                                    {
                                                      Fungible: *watr_buy_execution_amount,
                                                    },
                                                },
                                              weightLimit: Unlimited,
                                            },
                                        },
                                        {
                                          DepositAsset:
                                            {
                                              assets: { Wild: All },
                                              maxAssets: 1,
                                              beneficiary:
                                                {
                                                  parents: 0,
                                                  interior:
                                                    {
                                                      X1:
                                                        {
                                                          AccountId32:
                                                            {
                                                              network,
                                                              id: *stmt_asset_receiver_acc,
                                                            },
                                                        },
                                                    },
                                                },
                                            },
                                        }, # wrong asset
                                      ],
                                  },
                              },
                            ],
                        },
                        # maxWeight: Weight
                        *weight_at_most,
                      ]
                    events:
                      - name: system.ExtrinsicFailed
                        attributes:
                          - type: SpRuntimeDispatchError
                            key: dispatchError
                            value: {
                                Module: { index: 31, error: "0x02000000" },
                              } # polkadotXcm.Filtered

          - name: Execution filter should fail if  WithdrawAsset amount is smaller than BuyExecution amount
            actions:
              - extrinsics:
                  - chain: *watr_parachain
                    signer: *watr_asset_sender_signer
                    pallet: polkadotXcm
                    call: execute
                    args: [
                        # message: XcmVersionedXcm
                        {
                          v3:
                            [
                              {
                                WithdrawAsset:
                                  [
                                    {
                                      id:
                                        {
                                          Concrete: *stmt_remote_asset_location,
                                        },
                                      fun: { Fungible: 1000000 }, # too small amount
                                    },
                                  ],
                              },
                              {
                                InitiateReserveWithdraw:
                                  {
                                    assets: { Wild: All },
                                    reserve: *watr->stmt_dest,
                                    xcm:
                                      [
                                        {
                                          BuyExecution:
                                            {
                                              fees:
                                                {
                                                  id:
                                                    {
                                                      Concrete: *stmt_local_asset_location,
                                                    },
                                                  fun: { Fungible: 2000000 },
                                                },
                                              weightLimit: Unlimited,
                                            },
                                        },
                                        {
                                          DepositAsset:
                                            {
                                              assets: { Wild: All },
                                              maxAssets: 1,
                                              beneficiary:
                                                {
                                                  parents: 0,
                                                  interior:
                                                    {
                                                      X1:
                                                        {
                                                          AccountId32:
                                                            {
                                                              network,
                                                              id: *stmt_asset_receiver_acc,
                                                            },
                                                        },
                                                    },
                                                },
                                            },
                                        },
                                      ],
                                  },
                              },
                            ],
                        },
                        # maxWeight: Weight
                        *weight_at_most,
                      ]
                    events:
                      - name: system.ExtrinsicFailed
                        attributes:
                          - type: SpRuntimeDispatchError
                            key: dispatchError
                            value: {
                                Module: { index: 31, error: "0x02000000" },
                              } # polkadotXcm.Filtered

          - name: Execution filter should fail if InitiateReserveWithdraw to a wrong Reserve
            actions:
              - extrinsics:
                  - chain: *watr_parachain
                    signer: *watr_asset_sender_signer
                    pallet: polkadotXcm
                    call: execute
                    args: [
                        # message: XcmVersionedXcm
                        {
                          v3:
                            [
                              {
                                WithdrawAsset:
                                  [
                                    {
                                      id:
                                        {
                                          Concrete: *stmt_remote_asset_location,
                                        },
                                      fun:
                                        {
                                          Fungible: *watr_asset_amount_to_send,
                                        },
                                    },
                                  ],
                              },
                              { InitiateReserveWithdraw: {
                                    assets: { Wild: All },
                                    reserve: *watr->wrong_dest, # wrong reserve
                                    xcm:
                                      [
                                        {
                                          BuyExecution:
                                            {
                                              fees:
                                                {
                                                  id:
                                                    {
                                                      Concrete: *stmt_local_asset_location,
                                                    },
                                                  fun:
                                                    {
                                                      Fungible: *watr_buy_execution_amount,
                                                    },
                                                },
                                              weightLimit: Unlimited,
                                            },
                                        },
                                        {
                                          DepositAsset:
                                            {
                                              assets: { Wild: All },
                                              maxAssets: 1,
                                              beneficiary:
                                                {
                                                  parents: 0,
                                                  interior:
                                                    {
                                                      X1:
                                                        {
                                                          AccountId32:
                                                            {
                                                              network,
                                                              id: *stmt_asset_receiver_acc,
                                                            },
                                                        },
                                                    },
                                                },
                                            },
                                        },
                                      ],
                                  } },
                            ],
                        },
                        # maxWeight: Weight
                        *weight_at_most,
                      ]
                    events:
                      - name: system.ExtrinsicFailed
                        attributes:
                          - type: SpRuntimeDispatchError
                            key: dispatchError
                            value: {
                                Module: { index: 31, error: "0x02000000" },
                              } # polkadotXcm.Filtered

          - name: Execution filter should fail if InitiateReserveWithdraw wrong Asset
            actions:
              - extrinsics:
                  - chain: *watr_parachain
                    signer: *watr_asset_sender_signer
                    pallet: polkadotXcm
                    call: execute
                    args: [
                        # message: XcmVersionedXcm
                        { v3: [
                              {
                                WithdrawAsset:
                                  [
                                    {
                                      id:
                                        {
                                          Concrete: *stmt_remote_asset_location,
                                        },
                                      fun:
                                        {
                                          Fungible: *watr_asset_amount_to_send,
                                        },
                                    },
                                  ],
                              },
                              {
                                InitiateReserveWithdraw:
                                  {
                                    assets:
                                      {
                                        Wild:
                                          {
                                            AllOf:
                                              {
                                                id:
                                                  {
                                                    Concrete: *stmt_local_asset_location,
                                                  },
                                                fun:
                                                  {
                                                    Fungible: *watr_buy_execution_amount,
                                                  },
                                              },
                                          },
                                      },
                                    reserve: *watr->stmt_dest,
                                    xcm:
                                      [
                                        {
                                          BuyExecution:
                                            {
                                              fees:
                                                {
                                                  id:
                                                    {
                                                      Concrete: *stmt_local_asset_location,
                                                    },
                                                  fun:
                                                    {
                                                      Fungible: *watr_buy_execution_amount,
                                                    },
                                                },
                                              weightLimit: Unlimited,
                                            },
                                        },
                                        {
                                          DepositAsset:
                                            {
                                              assets: { Wild: All },
                                              maxAssets: 1,
                                              beneficiary:
                                                {
                                                  parents: 0,
                                                  interior:
                                                    {
                                                      X1:
                                                        {
                                                          AccountId32:
                                                            {
                                                              network,
                                                              id: *stmt_asset_receiver_acc,
                                                            },
                                                        },
                                                    },
                                                },
                                            },
                                        },
                                      ],
                                  },
                              }, # wrong asset
                            ] },
                        # maxWeight: Weight
                        *weight_at_most,
                      ]
                    events:
                      - name: system.ExtrinsicFailed
                        attributes:
                          - type: SpRuntimeDispatchError
                            key: dispatchError
                            value: {
                                Module: { index: 31, error: "0x02000000" },
                              } # polkadotXcm.Filtered

          - name: Execution filter should fail if BuyExecution of a wrong Asset
            actions:
              - extrinsics:
                  - chain: *watr_parachain
                    signer: *watr_asset_sender_signer
                    pallet: polkadotXcm
                    call: execute
                    args: [
                        # message: XcmVersionedXcm
                        {
                          v3:
                            [
                              {
                                WithdrawAsset:
                                  [
                                    {
                                      id:
                                        {
                                          Concrete: *stmt_remote_asset_location,
                                        },
                                      fun:
                                        {
                                          Fungible: *watr_asset_amount_to_send,
                                        },
                                    },
                                  ],
                              },
                              {
                                InitiateReserveWithdraw:
                                  {
                                    assets: { Wild: All },
                                    reserve: *watr->stmt_dest,
                                    xcm: [
                                        {
                                          BuyExecution:
                                            {
                                              fees:
                                                {
                                                  id:
                                                    {
                                                      Concrete: *wrong_local_asset_location,
                                                    },
                                                  fun:
                                                    {
                                                      Fungible: *watr_buy_execution_amount,
                                                    },
                                                },
                                              weightLimit: Unlimited,
                                            },
                                        },
                                        {
                                          DepositAsset:
                                            {
                                              assets: { Wild: All },
                                              maxAssets: 1,
                                              beneficiary:
                                                {
                                                  parents: 0,
                                                  interior:
                                                    {
                                                      X1:
                                                        {
                                                          AccountId32:
                                                            {
                                                              network,
                                                              id: *stmt_asset_receiver_acc,
                                                            },
                                                        },
                                                    },
                                                },
                                            },
                                        }, # wrong asset
                                      ],
                                  },
                              },
                            ],
                        },
                        # maxWeight: Weight
                        *weight_at_most,
                      ]
                    events:
                      - name: system.ExtrinsicFailed
                        attributes:
                          - type: SpRuntimeDispatchError
                            key: dispatchError
                            value: {
                                Module: { index: 31, error: "0x02000000" },
                              } # polkadotXcm.Filtered

          - name: Execution filter should fail if DepositAsset of a wrong Asset
            actions:
              - extrinsics:
                  - chain: *watr_parachain
                    signer: *watr_asset_sender_signer
                    pallet: polkadotXcm
                    call: execute
                    args: [
                        # message: XcmVersionedXcm
                        {
                          v3:
                            [
                              {
                                WithdrawAsset:
                                  [
                                    {
                                      id:
                                        {
                                          Concrete: *stmt_remote_asset_location,
                                        },
                                      fun:
                                        {
                                          Fungible: *watr_asset_amount_to_send,
                                        },
                                    },
                                  ],
                              },
                              {
                                InitiateReserveWithdraw:
                                  {
                                    assets: { Wild: All },
                                    reserve: *watr->stmt_dest,
                                    xcm: [
                                        {
                                          BuyExecution:
                                            {
                                              fees:
                                                {
                                                  id:
                                                    {
                                                      Concrete: *stmt_local_asset_location,
                                                    },
                                                  fun:
                                                    {
                                                      Fungible: *watr_buy_execution_amount,
                                                    },
                                                },
                                              weightLimit: Unlimited,
                                            },
                                        },
                                        {
                                          DepositAsset:
                                            {
                                              assets:
                                                {
                                                  Wild:
                                                    {
                                                      AllOf:
                                                        {
                                                          id:
                                                            {
                                                              Concrete: *stmt_local_asset_location,
                                                            },
                                                          fun:
                                                            {
                                                              Fungible: *watr_buy_execution_amount,
                                                            },
                                                        },
                                                    },
                                                },
                                              maxAssets: 1,
                                              beneficiary:
                                                {
                                                  parents: 0,
                                                  interior:
                                                    {
                                                      X1:
                                                        {
                                                          AccountId32:
                                                            {
                                                              network,
                                                              id: *stmt_asset_receiver_acc,
                                                            },
                                                        },
                                                    },
                                                },
                                            },
                                        }, # wrong asset
                                      ],
                                  },
                              },
                            ],
                        },
                        # maxWeight: Weight
                        *weight_at_most,
                      ]
                    events:
                      - name: system.ExtrinsicFailed
                        attributes:
                          - type: SpRuntimeDispatchError
                            key: dispatchError
                            value: {
                                Module: { index: 31, error: "0x02000000" },
                              } # polkadotXcm.Filtered

          - name: Execution filter should fail if DepositAsset to a wrong beneficiary
            actions:
              - extrinsics:
                  - chain: *watr_parachain
                    signer: *watr_asset_sender_signer
                    pallet: polkadotXcm
                    call: execute
                    args: [
                        # message: XcmVersionedXcm
                        {
                          v3:
                            [
                              {
                                WithdrawAsset:
                                  [
                                    {
                                      id:
                                        {
                                          Concrete: *stmt_remote_asset_location,
                                        },
                                      fun:
                                        {
                                          Fungible: *watr_asset_amount_to_send,
                                        },
                                    },
                                  ],
                              },
                              {
                                InitiateReserveWithdraw:
                                  {
                                    assets: { Wild: All },
                                    reserve: *watr->stmt_dest,
                                    xcm:
                                      [
                                        {
                                          BuyExecution:
                                            {
                                              fees:
                                                {
                                                  id:
                                                    {
                                                      Concrete: *stmt_local_asset_location,
                                                    },
                                                  fun:
                                                    {
                                                      Fungible: *watr_buy_execution_amount,
                                                    },
                                                },
                                              weightLimit: Unlimited,
                                            },
                                        },
                                        { DepositAsset: {
                                              assets: { Wild: All },
                                              # maxAssets: 1,
                                              beneficiary: {
                                                  parents: 1, # wrong beneficiary
                                                  interior:
                                                    {
                                                      X1:
                                                        {
                                                          AccountId32:
                                                            {
                                                              network,
                                                              id: *stmt_asset_receiver_acc,
                                                            },
                                                        },
                                                    },
                                                },
                                            } },
                                      ],
                                  },
                              },
                            ],
                        },
                        # maxWeight: Weight
                        *weight_at_most,
                      ]
                    events:
                      - name: system.ExtrinsicFailed
                        attributes:
                          - type: SpRuntimeDispatchError
                            key: dispatchError
                            value: {
                                Module: { index: 31, error: "0x02000000" },
                              } # polkadotXcm.Filtered

          - name: Execution filter should fail if only WithdrawAsset
            actions:
              - extrinsics:
                  - chain: *watr_parachain
                    signer: *watr_asset_sender_signer
                    pallet: polkadotXcm
                    call: execute
                    args: [
                        # message: XcmVersionedXcm
                        {
                          v3:
                            [
                              {
                                WithdrawAsset:
                                  [
                                    {
                                      id:
                                        {
                                          Concrete: *stmt_remote_asset_location,
                                        },
                                      fun:
                                        {
                                          Fungible: *watr_asset_amount_to_send,
                                        },
                                    },
                                  ],
                              },
                            ],
                        },
                        # maxWeight: Weight
                        *weight_at_most,
                      ]
                    events:
                      - name: system.ExtrinsicFailed
                        attributes:
                          - type: SpRuntimeDispatchError
                            key: dispatchError
                            value: {
                                Module: { index: 31, error: "0x02000000" },
                              } # polkadotXcm.Filtered

          - name: Execution filter should fail if only InitiateReserveWithdraw
            actions:
              - extrinsics:
                  - chain: *watr_parachain
                    signer: *watr_asset_sender_signer
                    pallet: polkadotXcm
                    call: execute
                    args: [
                        # message: XcmVersionedXcm
                        {
                          v3:
                            [
                              {
                                InitiateReserveWithdraw:
                                  {
                                    assets: { Wild: All },
                                    reserve: *watr->stmt_dest,
                                    xcm:
                                      [
                                        {
                                          BuyExecution:
                                            {
                                              fees:
                                                {
                                                  id:
                                                    {
                                                      Concrete: *stmt_local_asset_location,
                                                    },
                                                  fun:
                                                    {
                                                      Fungible: *watr_buy_execution_amount,
                                                    },
                                                },
                                              weightLimit: Unlimited,
                                            },
                                        },
                                        {
                                          DepositAsset:
                                            {
                                              assets: { Wild: All },
                                              maxAssets: 1,
                                              beneficiary: {
                                                  parents: 1, # wrong beneficiary
                                                  interior:
                                                    {
                                                      X1:
                                                        {
                                                          AccountId32:
                                                            {
                                                              network,
                                                              id: *stmt_asset_receiver_acc,
                                                            },
                                                        },
                                                    },
                                                },
                                            },
                                        },
                                      ],
                                  },
                              },
                            ],
                        },
                        # maxWeight: Weight
                        *weight_at_most,
                      ]
                    events:
                      - name: system.ExtrinsicFailed
                        attributes:
                          - type: SpRuntimeDispatchError
                            key: dispatchError
                            value: {
                                Module: { index: 31, error: "0x02000000" },
                              } # polkadotXcm.Filtered
